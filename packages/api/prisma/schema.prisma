// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model for authentication (to be used with NextAuth)
model User {
  id                String          @id @default(cuid())
  email             String          @unique
  name              String?
  passwordHash      String?
  role              UserRole        @default(USER)
  organizationId    String?
  organization      Organization?   @relation(fields: [organizationId], references: [id])
  assessments       Assessment[]
  imports           ImportHistory[]
  resetToken        String?
  resetTokenExpires DateTime?
  assignedAccounts  RecoveryAccount[] @relation("AssignedAccounts")
  assignedWorkItems WorkQueueItem[]   @relation("AssignedWorkItems")
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
}

enum UserRole {
  ADMIN
  USER
  VIEWER
}

// Organization/Hospital model
model Organization {
  id              String           @id @default(cuid())
  name            String
  type            String? // hospital, rcm_vendor, etc.
  settings        Json?
  users           User[]
  assessments     Assessment[]
  imports         ImportHistory[]
  presets         CustomPreset[]
  sftpConnections SFTPConnection[]
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
}

// Main Assessment model
model Assessment {
  id String @id @default(cuid())

  // Patient/Account Info
  accountNumber    String?
  mrn              String?
  patientFirstName String?
  patientLastName  String?
  patientDob       DateTime?
  patientState     String?

  // Encounter Details
  encounterType String // inpatient, outpatient, ed, observation
  admissionDate DateTime?
  dischargeDate DateTime?
  lengthOfStay  Int?
  totalCharges  Decimal   @db.Decimal(12, 2)
  facilityState String
  facilityType  String?

  // Insurance Status
  insuranceStatusOnDos String // uninsured, underinsured, medicaid, medicare, commercial
  medicaidStatus       String?
  medicareStatus       String?
  ssiStatus            String?
  ssdiStatus           String?

  // Financial Screening
  householdIncome String?
  householdSize   Int?
  estimatedAssets String?

  // Disability Assessment
  disabilityLikelihood  String?
  ssiEligibilityLikely  Boolean?
  ssdiEligibilityLikely Boolean?

  // Recovery Results
  primaryRecoveryPath    String
  overallConfidence      Int
  estimatedTotalRecovery Decimal @db.Decimal(12, 2)

  // Medicaid Results
  medicaidResultStatus      String?
  medicaidResultConfidence  Int?
  medicaidResultPathway     String?
  medicaidResultActions     Json?
  medicaidEstimatedRecovery Decimal? @db.Decimal(12, 2)

  // Medicare Results
  medicareResultStatus     String?
  medicareResultConfidence Int?

  // DSH Results
  dshRelevance      String?
  dshScore          Int?
  dshAuditReadiness String?
  dshFactors        Json?

  // State Program Results
  stateProgramArchetype  String?
  stateProgramName       String?
  stateProgramConfidence Int?
  stateProgramEligible   Boolean?

  // Actions and Documentation
  priorityActions     Json?
  immediateActions    Json?
  followUpActions     Json?
  documentationNeeded Json?

  // Metadata
  tags   String[]
  notes  String?
  status AssessmentStatus @default(PENDING)

  // Relations
  userId         String?
  user           User?          @relation(fields: [userId], references: [id])
  organizationId String?
  organization   Organization?  @relation(fields: [organizationId], references: [id])
  importId       String?
  import         ImportHistory? @relation(fields: [importId], references: [id])
  recoveryAccounts RecoveryAccount[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([accountNumber])
  @@index([mrn])
  @@index([primaryRecoveryPath])
  @@index([facilityState])
  @@index([createdAt])
  @@index([status])
}

enum AssessmentStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  EXPORTED
  ARCHIVED
}

// Import History
model ImportHistory {
  id           String  @id @default(cuid())
  filename     String
  originalName String?
  fileSize     Int
  mimeType     String?

  presetUsed String?
  presetName String?

  totalRows      Int
  processedRows  Int
  successfulRows Int
  failedRows     Int
  skippedRows    Int

  errors   Json?
  warnings Json?

  status      ImportStatus @default(PENDING)
  startedAt   DateTime?
  completedAt DateTime?

  // Job Queue Integration
  jobId             String?   @unique
  progress          Int       @default(0)
  currentRow        Int       @default(0)
  currentChunk      Int       @default(0)
  totalChunks       Int       @default(0)

  // Processing Options
  chunkSize         Int       @default(100)
  duplicatesFound   Int       @default(0)
  duplicatesSkipped Int       @default(0)

  // Timing
  processingStartedAt DateTime?
  estimatedCompletion DateTime?

  // Resumability
  lastProcessedRow    Int       @default(0)
  checkpointData      Json?

  // Relations
  userId         String?
  user           User?         @relation(fields: [userId], references: [id])
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])
  assessments    Assessment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([createdAt])
}

enum ImportStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

// Custom Presets (organization-specific)
model CustomPreset {
  id          String  @id @default(cuid())
  name        String
  vendor      String?
  description String?

  mappings       Json // ColumnMapping[]
  dateFormat     String @default("MM/DD/YYYY")
  currencyFormat String @default("decimal")
  delimiter      String @default(",")
  skipHeaderRows Int    @default(1)

  isActive   Boolean   @default(true)
  usageCount Int       @default(0)
  lastUsedAt DateTime?

  // Relations
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, name])
  @@index([vendor])
}

// Audit Log
model AuditLog {
  id         String   @id @default(cuid())
  action     String // CREATE, UPDATE, DELETE, EXPORT, IMPORT
  entityType String // Assessment, Import, Preset, etc.
  entityId   String?
  userId     String?
  details    Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  @@index([entityType, entityId])
  @@index([userId])
  @@index([createdAt])
}

// SFTP Connection Configuration
model SFTPConnection {
  id                  String    @id @default(cuid())
  name                String

  // Connection details
  host                String
  port                Int       @default(22)
  username            String
  encryptedPassword   String?   // Encrypted at rest
  encryptedPrivateKey String?   // Encrypted at rest

  // Paths
  inboundPath         String    @default("/inbound")
  outboundPath        String    @default("/outbound")
  archivePath         String    @default("/archive")
  errorPath           String?

  // Processing
  filePattern         String    @default("*.csv")
  presetId            String?
  autoProcess         Boolean   @default(true)
  deleteAfterProcess  Boolean   @default(false)

  // Scheduling
  enabled             Boolean   @default(true)
  pollIntervalMinutes Int       @default(15)
  schedule            String?   // Cron expression

  // Status
  lastConnectedAt     DateTime?
  lastSyncAt          DateTime?
  lastError           String?
  consecutiveFailures Int       @default(0)

  // Relations
  organizationId      String
  organization        Organization  @relation(fields: [organizationId], references: [id])
  syncLogs            SFTPSyncLog[]

  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@unique([organizationId, name])
  @@index([enabled])
}

// SFTP Sync Log
model SFTPSyncLog {
  id             String         @id @default(cuid())
  connectionId   String
  connection     SFTPConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  status         String         // success, partial, failed
  startedAt      DateTime
  completedAt    DateTime?

  filesFound     Int            @default(0)
  filesProcessed Int            @default(0)
  filesFailed    Int            @default(0)
  filesSkipped   Int            @default(0)

  errors         Json?
  importIds      String[]

  createdAt      DateTime       @default(now())

  @@index([connectionId])
  @@index([status])
  @@index([createdAt])
}

// ============================================
// Revenue Cycle Management Models
// ============================================

// Recovery Account - tracks a patient account through the recovery process
model RecoveryAccount {
  id              String                @id @default(cuid())
  assessmentId    String
  assessment      Assessment            @relation(fields: [assessmentId], references: [id])

  status          RecoveryAccountStatus @default(INTAKE)

  // Financial tracking
  originalCharges   Decimal   @db.Decimal(12, 2)
  adjustments       Decimal   @db.Decimal(12, 2) @default(0)
  currentBalance    Decimal   @db.Decimal(12, 2)
  projectedRecovery Decimal   @db.Decimal(12, 2) @default(0)
  actualRecovery    Decimal   @db.Decimal(12, 2) @default(0)

  // Assignment
  assignedToId    String?
  assignedTo      User?     @relation("AssignedAccounts", fields: [assignedToId], references: [id])

  // Critical dates
  timelyFilingDate DateTime?
  appealDeadline   DateTime?

  // Relations
  claims            Claim[]
  communications    Communication[]
  complianceNotices ComplianceNotice[]
  workQueueItems    WorkQueueItem[]

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([assessmentId])
  @@index([status])
  @@index([assignedToId])
  @@index([timelyFilingDate])
  @@index([appealDeadline])
  @@index([createdAt])
}

enum RecoveryAccountStatus {
  INTAKE
  SCREENED
  ELIGIBILITY_PENDING
  BILLED
  PAID
  CLOSED
  WRITTEN_OFF
}

// Claim - individual claims submitted for a recovery account
model Claim {
  id          String          @id @default(cuid())
  accountId   String
  account     RecoveryAccount @relation(fields: [accountId], references: [id])

  claimNumber String?
  payerType   PayerType

  status        ClaimStatus @default(DRAFT)
  submittedDate DateTime?

  // Financial amounts
  billedAmount          Decimal  @db.Decimal(12, 2)
  allowedAmount         Decimal? @db.Decimal(12, 2)
  paidAmount            Decimal? @db.Decimal(12, 2)
  patientResponsibility Decimal? @db.Decimal(12, 2)

  // Denial information
  denialCode   String?
  denialReason String?
  denialDate   DateTime?

  // Relations
  denials Denial[]
  appeals Appeal[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([accountId])
  @@index([claimNumber])
  @@index([payerType])
  @@index([status])
  @@index([submittedDate])
  @@index([denialDate])
}

enum PayerType {
  MEDICAID
  MEDICARE
  COMMERCIAL
  SELF_PAY
}

enum ClaimStatus {
  DRAFT
  SUBMITTED
  PENDING
  PAID
  DENIED
  APPEALED
}

// Denial - tracks claim denials and their resolution
model Denial {
  id       String @id @default(cuid())
  claimId  String
  claim    Claim  @relation(fields: [claimId], references: [id])

  // Denial codes
  carcCode String?
  rarcCode String?
  category DenialCategory

  // Financial impact
  deniedAmount Decimal   @db.Decimal(12, 2)
  denialDate   DateTime

  // Resolution
  resolution      DenialResolution?
  resolvedDate    DateTime?
  recoveredAmount Decimal?          @db.Decimal(12, 2)

  // Analysis
  preventable Boolean @default(false)
  rootCause   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([claimId])
  @@index([category])
  @@index([denialDate])
  @@index([resolution])
  @@index([preventable])
}

enum DenialCategory {
  ELIGIBILITY
  AUTHORIZATION
  CODING
  TIMELY_FILING
  DUPLICATE
  MEDICAL_NECESSITY
  BUNDLING
  COB
  TECHNICAL
  OTHER
}

enum DenialResolution {
  OVERTURNED
  UPHELD
  PARTIAL_RECOVERY
  WRITTEN_OFF
  PENDING
}

// Appeal - tracks appeals filed for denied claims
model Appeal {
  id       String @id @default(cuid())
  claimId  String
  claim    Claim  @relation(fields: [claimId], references: [id])

  appealLevel Int          // 1, 2, 3
  filedDate   DateTime?
  deadline    DateTime?
  status      AppealStatus @default(DRAFT)

  // Outcome
  outcome         String?
  decisionDate    DateTime?
  recoveredAmount Decimal? @db.Decimal(12, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([claimId])
  @@index([appealLevel])
  @@index([status])
  @@index([deadline])
  @@index([filedDate])
}

enum AppealStatus {
  DRAFT
  FILED
  UNDER_REVIEW
  WON
  LOST
}

// Communication - tracks all communications related to an account
model Communication {
  id        String          @id @default(cuid())
  accountId String
  account   RecoveryAccount @relation(fields: [accountId], references: [id])

  type      CommunicationType
  direction CommunicationDirection

  subject String?
  content String?
  sentAt  DateTime?

  // 501(r) compliance tracking
  is501rNotice Boolean @default(false)
  noticeType   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([accountId])
  @@index([type])
  @@index([direction])
  @@index([sentAt])
  @@index([is501rNotice])
}

enum CommunicationType {
  EMAIL
  SMS
  LETTER
  CALL
  PORTAL_MESSAGE
}

enum CommunicationDirection {
  INBOUND
  OUTBOUND
}

// Compliance Notice - tracks 501(r) and other regulatory notices
model ComplianceNotice {
  id        String          @id @default(cuid())
  accountId String
  account   RecoveryAccount @relation(fields: [accountId], references: [id])

  noticeType     ComplianceNoticeType
  requiredByDate DateTime?
  sentDate       DateTime?

  deliveryMethod String?
  confirmed      Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([accountId])
  @@index([noticeType])
  @@index([requiredByDate])
  @@index([sentDate])
  @@index([confirmed])
}

enum ComplianceNoticeType {
  FAP_PLAIN_LANGUAGE
  ECA_30_DAY
  ECA_WRITTEN
  FAP_APPLICATION
  FAP_DETERMINATION
}

// Work Queue Item - tracks items in various work queues
model WorkQueueItem {
  id        String          @id @default(cuid())
  accountId String
  account   RecoveryAccount @relation(fields: [accountId], references: [id])

  queueType WorkQueueType
  priority  Int             @default(5) // 1-10, lower is higher priority
  dueDate   DateTime?

  assignedToId String?
  assignedTo   User?           @relation("AssignedWorkItems", fields: [assignedToId], references: [id])

  status WorkQueueItemStatus @default(PENDING)
  notes  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([accountId])
  @@index([queueType])
  @@index([priority])
  @@index([dueDate])
  @@index([assignedToId])
  @@index([status])
}

enum WorkQueueType {
  NEW_ACCOUNTS
  PENDING_ELIGIBILITY
  DENIALS
  APPEALS
  CALLBACKS
  COMPLIANCE
}

enum WorkQueueItemStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
}

