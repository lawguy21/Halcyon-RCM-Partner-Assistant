// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model for authentication (to be used with NextAuth)
model User {
  id                String          @id @default(cuid())
  email             String          @unique
  name              String?
  passwordHash      String?
  role              UserRole        @default(USER)
  organizationId    String?
  organization      Organization?   @relation(fields: [organizationId], references: [id])
  assessments       Assessment[]
  imports           ImportHistory[]
  resetToken        String?
  resetTokenExpires DateTime?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
}

enum UserRole {
  ADMIN
  USER
  VIEWER
}

// Organization/Hospital model
model Organization {
  id              String           @id @default(cuid())
  name            String
  type            String? // hospital, rcm_vendor, etc.
  settings        Json?
  users           User[]
  assessments     Assessment[]
  imports         ImportHistory[]
  presets         CustomPreset[]
  sftpConnections SFTPConnection[]
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
}

// Main Assessment model
model Assessment {
  id String @id @default(cuid())

  // Patient/Account Info
  accountNumber    String?
  mrn              String?
  patientFirstName String?
  patientLastName  String?
  patientDob       DateTime?
  patientState     String?

  // Encounter Details
  encounterType String // inpatient, outpatient, ed, observation
  admissionDate DateTime?
  dischargeDate DateTime?
  lengthOfStay  Int?
  totalCharges  Decimal   @db.Decimal(12, 2)
  facilityState String
  facilityType  String?

  // Insurance Status
  insuranceStatusOnDos String // uninsured, underinsured, medicaid, medicare, commercial
  medicaidStatus       String?
  medicareStatus       String?
  ssiStatus            String?
  ssdiStatus           String?

  // Financial Screening
  householdIncome String?
  householdSize   Int?
  estimatedAssets String?

  // Disability Assessment
  disabilityLikelihood  String?
  ssiEligibilityLikely  Boolean?
  ssdiEligibilityLikely Boolean?

  // Recovery Results
  primaryRecoveryPath    String
  overallConfidence      Int
  estimatedTotalRecovery Decimal @db.Decimal(12, 2)

  // Medicaid Results
  medicaidResultStatus      String?
  medicaidResultConfidence  Int?
  medicaidResultPathway     String?
  medicaidResultActions     Json?
  medicaidEstimatedRecovery Decimal? @db.Decimal(12, 2)

  // Medicare Results
  medicareResultStatus     String?
  medicareResultConfidence Int?

  // DSH Results
  dshRelevance      String?
  dshScore          Int?
  dshAuditReadiness String?
  dshFactors        Json?

  // State Program Results
  stateProgramArchetype  String?
  stateProgramName       String?
  stateProgramConfidence Int?
  stateProgramEligible   Boolean?

  // Actions and Documentation
  priorityActions     Json?
  immediateActions    Json?
  followUpActions     Json?
  documentationNeeded Json?

  // Metadata
  tags   String[]
  notes  String?
  status AssessmentStatus @default(PENDING)

  // Relations
  userId         String?
  user           User?          @relation(fields: [userId], references: [id])
  organizationId String?
  organization   Organization?  @relation(fields: [organizationId], references: [id])
  importId       String?
  import         ImportHistory? @relation(fields: [importId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([accountNumber])
  @@index([mrn])
  @@index([primaryRecoveryPath])
  @@index([facilityState])
  @@index([createdAt])
  @@index([status])
}

enum AssessmentStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  EXPORTED
  ARCHIVED
}

// Import History
model ImportHistory {
  id           String  @id @default(cuid())
  filename     String
  originalName String?
  fileSize     Int
  mimeType     String?

  presetUsed String?
  presetName String?

  totalRows      Int
  processedRows  Int
  successfulRows Int
  failedRows     Int
  skippedRows    Int

  errors   Json?
  warnings Json?

  status      ImportStatus @default(PENDING)
  startedAt   DateTime?
  completedAt DateTime?

  // Relations
  userId         String?
  user           User?         @relation(fields: [userId], references: [id])
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])
  assessments    Assessment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([createdAt])
}

enum ImportStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

// Custom Presets (organization-specific)
model CustomPreset {
  id          String  @id @default(cuid())
  name        String
  vendor      String?
  description String?

  mappings       Json // ColumnMapping[]
  dateFormat     String @default("MM/DD/YYYY")
  currencyFormat String @default("decimal")
  delimiter      String @default(",")
  skipHeaderRows Int    @default(1)

  isActive   Boolean   @default(true)
  usageCount Int       @default(0)
  lastUsedAt DateTime?

  // Relations
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, name])
  @@index([vendor])
}

// Audit Log
model AuditLog {
  id         String   @id @default(cuid())
  action     String // CREATE, UPDATE, DELETE, EXPORT, IMPORT
  entityType String // Assessment, Import, Preset, etc.
  entityId   String?
  userId     String?
  details    Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  @@index([entityType, entityId])
  @@index([userId])
  @@index([createdAt])
}

// SFTP Connection Configuration
model SFTPConnection {
  id                  String    @id @default(cuid())
  name                String

  // Connection details
  host                String
  port                Int       @default(22)
  username            String
  encryptedPassword   String?   // Encrypted at rest
  encryptedPrivateKey String?   // Encrypted at rest

  // Paths
  inboundPath         String    @default("/inbound")
  outboundPath        String    @default("/outbound")
  archivePath         String    @default("/archive")
  errorPath           String?

  // Processing
  filePattern         String    @default("*.csv")
  presetId            String?
  autoProcess         Boolean   @default(true)
  deleteAfterProcess  Boolean   @default(false)

  // Scheduling
  enabled             Boolean   @default(true)
  pollIntervalMinutes Int       @default(15)
  schedule            String?   // Cron expression

  // Status
  lastConnectedAt     DateTime?
  lastSyncAt          DateTime?
  lastError           String?
  consecutiveFailures Int       @default(0)

  // Relations
  organizationId      String
  organization        Organization  @relation(fields: [organizationId], references: [id])
  syncLogs            SFTPSyncLog[]

  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@unique([organizationId, name])
  @@index([enabled])
}

// SFTP Sync Log
model SFTPSyncLog {
  id             String         @id @default(cuid())
  connectionId   String
  connection     SFTPConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  status         String         // success, partial, failed
  startedAt      DateTime
  completedAt    DateTime?

  filesFound     Int            @default(0)
  filesProcessed Int            @default(0)
  filesFailed    Int            @default(0)
  filesSkipped   Int            @default(0)

  errors         Json?
  importIds      String[]

  createdAt      DateTime       @default(now())

  @@index([connectionId])
  @@index([status])
  @@index([createdAt])
}
